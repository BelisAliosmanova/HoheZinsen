<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interest Rate Offers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">

    <!-- Enhanced scrolling styles -->
    <style>
        /* Enhanced table scrolling */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        /* Custom scrollbar styling */
        .table-responsive::-webkit-scrollbar {
            height: 12px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
            border: 2px solid #f1f1f1;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Ensure table has minimum width for proper scrolling */
        #mainTable {
            min-width: 800px;
            margin-bottom: 0;
        }

        /* Prevent column content from wrapping */
        #mainTable th,
        #mainTable td {
            white-space: nowrap;
            min-width: 120px;
        }

        /* Actions column should be wider */
        #mainTable th:last-child,
        #mainTable td:last-child {
            min-width: 200px;
        }

        /* Mobile responsive - disable horizontal scroll in mobile stack view */
        @media (max-width: 768px) {
            .table-responsive.mobile-stack {
                overflow-x: visible;
                border: none;
                box-shadow: none;
            }

            .table-responsive.mobile-stack #mainTable {
                min-width: auto;
            }

            .table-responsive.mobile-stack #mainTable th,
            .table-responsive.mobile-stack #mainTable td {
                min-width: auto;
                white-space: normal;
            }
        }

        /* Fix for expanded card row spacing issues */
        .rate-card-row {
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            background: transparent !important;
        }

        .rate-card-row td {
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            background: transparent !important;
            line-height: 0 !important;
            height: auto !important;
        }

        .rate-card {
            margin: 0 !important;
            line-height: normal !important;
        }

        /* Ensure no ghost spacing */
        tr.rate-card-row {
            display: none;
        }

        tr.rate-card-row.show {
            display: table-row;
        }

        /* Optional: Scroll indicator for better UX */
        .scroll-indicator {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        .scroll-indicator.show {
            opacity: 1;
        }

        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pagination-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-size-selector select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            min-width: 40px;
            text-align: center;
        }

        .page-btn:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .page-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-input {
            width: 60px;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }

        .pagination-jump {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
            padding-left: 15px;
            border-left: 1px solid #eee;
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            position: relative;
        }

        /* Empty state styles */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ddd;
        }

        /* Mobile responsive pagination */
        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .pagination-info {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .pagination-controls {
                justify-content: center;
                flex-wrap: wrap;
            }

            .pagination-jump {
                margin-left: 0;
                padding-left: 0;
                border-left: none;
                border-top: 1px solid #eee;
                padding-top: 15px;
                justify-content: center;
            }
        }

        /* Quick navigation buttons */
        .quick-nav {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .quick-nav .page-btn {
            padding: 6px 10px;
            font-size: 12px;
            min-width: 35px;
        }

        /* Results per page indicator */
        .results-info {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div class="d-flex align-items-center flex-wrap">
            <h2 class="me-3 mb-2 mb-md-0">Interest Rate Offers</h2>
            <span class="order-changed-indicator" id="orderChangedIndicator">
                Order changed - click save to persist
            </span>
            <button class="save-order-btn" id="saveOrderBtn" onclick="saveColumnOrder()">
                Save Order
            </button>
        </div>
        <a class="btn btn-primary mt-2 mt-md-0" href="/interest-rate/new">+ Add New Interest Rate</a>
    </div>

    <!-- Form to Add a New Global Field -->
    <form class="mb-4" method="post" th:action="@{/fields/add}" th:object="${newField}">
        <div class="row g-2">
            <div class="col-md-6 col-lg-4">
                <input class="form-control" placeholder="Label (e.g. Max Deposit)" th:field="*{label}"/>
            </div>
            <div class="col-md-6 col-lg-4">
                <button class="btn btn-primary w-100">Add Field</button>
            </div>
        </div>
    </form>

    <!-- View Toggle for Mobile -->
    <div class="view-toggle d-md-none">
        <div class="btn-group" role="group" aria-label="View toggle">
            <button type="button" class="btn btn-outline-primary active" id="stackedView">
                📱 Card View
            </button>
            <button type="button" class="btn btn-outline-primary" id="scrollView">
                📊 Table View
            </button>
        </div>
    </div>

    <!-- Pagination Controls - Top -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="results-info" id="resultsInfo">
                Showing 1-5 of 25 results
            </div>
            <div class="page-size-selector">
                <label for="pageSize">Show:</label>
                <select id="pageSize" onchange="changePageSize(this.value)">
                    <option value="5" selected>5 per page</option>
                    <option value="10">10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                </select>
            </div>
        </div>

        <div class="pagination-controls">
            <div class="quick-nav">
                <button class="page-btn" id="firstPageBtn" onclick="goToPage(1)" title="First page">⏮</button>
                <button class="page-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)" title="Previous page">‹</button>
            </div>

            <div id="pageNumbers" class="quick-nav">
                <!-- Page numbers will be generated here -->
            </div>

            <div class="quick-nav">
                <button class="page-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)" title="Next page">›</button>
                <button class="page-btn" id="lastPageBtn" onclick="goToPage(totalPages)" title="Last page">⏭</button>
            </div>

            <div class="pagination-jump">
                <span>Go to:</span>
                <input type="number" id="pageJumpInput" class="page-input" min="1" placeholder="1">
                <button class="page-btn" onclick="jumpToPage()">Go</button>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>

        <div class="scroll-indicator" id="scrollIndicator">← Scroll horizontally to see more →</div>

        <div class="table-responsive" id="tableContainer">
            <table class="table table-sm" id="mainTable">
                <thead class="table">
                <tr id="column-header-row">
                    <th class="draggable-column sortable"
                        draggable="true"
                        ondragend="handleDragEnd(event)"
                        ondragover="handleDragOver(event)"
                        ondragstart="handleDragStart(event)"
                        ondrop="handleDrop(event)"
                        onclick="sortTable(this, event)"
                        th:data-field-id="${field.id}"
                        th:data-column-index="${iterStat.index}"
                        th:each="field, iterStat : ${globalFields}">

                        <div class="drag-handle">⋮⋮</div>

                        <div class="header-container">
                            <span class="header-text" th:text="${field.label}"></span>
                            <button class="edit-header-btn" th:onclick="'showEditForm(' + ${field.id} + ')'" type="button">
                                ✎
                            </button>
                            <button class="delete-field-btn"
                                    th:data-id="${field.id}"
                                    th:data-label="${field.label}"
                                    onclick="handleFieldDeleteClick(this)"
                                    type="button"
                                    title="Delete this field">
                                🗑
                            </button>

                            <!-- Edit Form -->
                            <div class="header-edit-form" th:id="'editForm_' + ${field.id}">
                                <form method="post" th:action="@{/fields/update}">
                                    <input name="fieldId" th:value="${field.id}" type="hidden"/>

                                    <div class="form-row">
                                        <label>Display Label:</label>
                                        <input name="label" required th:value="${field.label}" type="text"/>
                                    </div>

                                    <div class="form-buttons">
                                        <button class="save-btn" type="submit">Save</button>
                                        <button class="cancel-btn" th:onclick="'hideEditForm(' + ${field.id} + ')'"
                                                type="button">Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </th>
                    <th class="no-drag">Actions</th>
                </tr>
                </thead>

                <tbody id="tableBody">
                <!-- Data rows will be populated by JavaScript -->
                </tbody>
            </table>

            <!-- Empty state -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div>📊</div>
                <h5>No interest rates found</h5>
                <p>Try adjusting your search criteria or add a new interest rate.</p>
            </div>
        </div>
    </div>

    <!-- Pagination Controls - Bottom -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="results-info" id="resultsInfoBottom">
                Showing 1-5 of 25 results
            </div>
        </div>

        <div class="pagination-controls">
            <div class="quick-nav">
                <button class="page-btn" onclick="goToPage(1)" title="First page">⏮</button>
                <button class="page-btn" onclick="goToPage(currentPage - 1)" title="Previous page">‹</button>
            </div>

            <div id="pageNumbersBottom" class="quick-nav">
                <!-- Page numbers will be generated here -->
            </div>

            <div class="quick-nav">
                <button class="page-btn" onclick="goToPage(currentPage + 1)" title="Next page">›</button>
                <button class="page-btn" onclick="goToPage(totalPages)" title="Last page">⏭</button>
            </div>
        </div>
    </div>
</div>

<!-- Keep all your existing modals and notifications -->
<!-- Field Delete Confirmation Modal -->
<div class="delete-confirmation-modal" id="fieldDeleteConfirmationModal">
    <div class="delete-confirmation-content">
        <h5>⚠️ Delete Field</h5>
        <div class="field-info">
            <p><strong>Field:</strong> <span id="fieldToDeleteName">Field Name</span></p>
            <p><strong>ID:</strong> <span id="fieldToDeleteId">Field ID</span></p>
        </div>
        <p>Are you sure you want to delete this field (column)?</p>
        <div class="warning-text">
            ⚠️ This will permanently remove the field and ALL associated data for every interest rate!
        </div>
        <p><strong>This action cannot be undone.</strong></p>

        <div class="delete-confirmation-buttons">
            <button class="btn btn-danger" id="confirmFieldDeleteBtn">Yes, Delete Field</button>
            <button class="btn btn-secondary" onclick="hideFieldDeleteConfirmation()">Cancel</button>
        </div>
    </div>
</div>

<!-- Interest Rate Delete Confirmation Modal -->
<div class="delete-confirmation-modal" id="deleteConfirmationModal">
    <div class="delete-confirmation-content">
        <h5>⚠️ Confirm Deletion</h5>
        <p>Are you sure you want to delete this interest rate?</p>
        <p><strong>This action cannot be undone.</strong></p>

        <div class="delete-confirmation-buttons">
            <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
            <button class="btn btn-secondary" onclick="hideDeleteConfirmation()">Cancel</button>
        </div>
    </div>
</div>

<!-- Drop indicator -->
<div class="drop-indicator" id="dropIndicator"></div>

<!-- Delete notification -->
<div class="delete-notification" id="deleteNotification">
    Action completed successfully!
</div>

<!-- Include jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script th:inline="javascript">
    // Pagination variables
    let currentPage = 1;
    let pageSize = 5;
    let totalRecords = 0;
    let totalPages = 0;
    let allInterestRates = /*[[${interestRates}]]*/ [];
    let filteredRates = [];
    let isLoading = false;

    // Keep all your existing variables
    let currentExpandedCard = null;
    let currentEditForm = null;
    let draggedElement = null;
    let orderChanged = false;
    let originalOrder = [];
    let pendingDeleteId = null;
    let pendingFieldDeleteId = null;
    let draggedSection = null;
    let currentRateId = null;
    let currentSortColumn = null;
    let currentSortDirection = null;

    document.addEventListener('DOMContentLoaded', function () {
        initializePagination();
        captureOriginalOrder();
        initializeSortableHeaders();
        initializeResponsiveToggle();
        initializeScrollIndicator();
        initializeSearch(); // Add search functionality

        // Load first page from server
        loadPageFromServer(1);
    });

    function loadPageFromServer(page, searchTerm = '') {
    if (isLoading) return;

    showLoading();

    const params = new URLSearchParams({
        page: page - 1, // Spring uses 0-based indexing
        size: pageSize,
        sortBy: currentSortColumn || 'id',
        sortDir: currentSortDirection || 'asc'
    });

    if (searchTerm && searchTerm.trim()) {
        params.append('search', searchTerm.trim());
    }

    // Use the correct endpoint
    fetch(`/api/interest-rates/paginated?${params.toString()}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }
            return response.json();
        })
        .then(data => {
            currentPage = page;
            totalPages = data.totalPages;
            totalRecords = data.totalElements;

            // Update global data arrays
            allInterestRates = data.content;
            filteredRates = data.content;

            // Store the field values map from server
            serverRateFieldValuesMap = data.rateFieldValuesMap;

            renderTableData(data.content);
            updatePaginationControls();
            updatePaginationInfo();
            hideLoading();

            // Close any expanded cards when changing pages
            if (currentExpandedCard) {
                closeExpandedCard(currentExpandedCard);
            }
        })
        .catch(error => {
            console.error('Error loading page:', error);
            showDeleteNotification('Error loading data: ' + error.message, true);
            hideLoading();
        });
}


    // Pagination Functions
    function initializePagination() {
        totalRecords = allInterestRates.length;
        filteredRates = [...allInterestRates];
        updatePaginationInfo();
    }

    function loadPage(page) {
        if (isLoading) return;

        showLoading();

        currentPage = page;

        // Simulate API call delay (remove this in production)
        setTimeout(() => {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = filteredRates.slice(startIndex, endIndex);

            renderTableData(pageData);
            updatePaginationControls();
            updatePaginationInfo();
            hideLoading();

            // Close any expanded cards when changing pages
            if (currentExpandedCard) {
                closeExpandedCard(currentExpandedCard);
            }
        }, 300);
    }

    function renderTableData(data) {
        const tbody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');

        if (data.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        // Check if we have headers in DOM (after column reordering)
        const headers = document.querySelectorAll('.draggable-column');
        if (headers.length > 0) {
            // Use current DOM order
            renderTableRows(data, tbody);
        } else {
            // Fetch global fields from server if not cached (initial load)
            if (!globalFieldsCache) {
                fetchGlobalFields()
                    .then(() => {
                        renderTableRows(data, tbody);
                    });
            } else {
                renderTableRows(data, tbody);
            }
        }
    }

    function renderTableRows(data, tbody) {
        tbody.innerHTML = data.map(rate => {
                // Get current header order from DOM instead of using cached order
                const headers = document.querySelectorAll('.draggable-column');
                const currentFieldOrder = Array.from(headers)
                    .map(header => ({
                        id: header.dataset.fieldId,
                        label: header.querySelector('.header-text')
                            .textContent
                    }));

                const fieldCells = currentFieldOrder.map(field => {
                        const fieldValue = serverRateFieldValuesMap[rate.id]?.[field.id] || '';
                        return `
                <td class="data-cell" data-field-id="${field.id}" data-label="${field.label}">
                    <form class="d-flex justify-content-center" method="post" action="/field-values/update">
                        <input name="rateId" value="${rate.id}" type="hidden"/>
                        <input name="fieldId" value="${field.id}" type="hidden"/>
                        <input class="form-control form-control-sm text-center"
                               name="value"
                               value="${fieldValue}"
                               type="text"
                               onchange="updateFieldValueAjax(${rate.id}, ${field.id}, this.value)"/>
                    </form>
                </td>
            `;
                    })
                    .join('');

                return `
            <tr data-rate-id="${rate.id}">
                ${fieldCells}
                <td data-label="Actions">
                    <div class="action-buttons">
                        <button class="mehr-info-btn"
                                ${rate.moreInfo ? '' : 'disabled'}
                                onclick="showMoreInfo(${rate.id})"
                                title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}">
                            ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                        </button>
                        <a class="angebot-btn"
                           href="${rate.webLink || '#'}"
                           target="_blank"
                           title="Open Link">
                            ZUM ANGEBOT
                        </a>
                        <a class="btn-edit" href="/interest-rate/edit/${rate.id}" title="Edit Interest Rate">
                            ✎ Edit
                        </a>
                        <button class="btn-delete"
                                onclick="showDeleteConfirmation(${rate.id})"
                                title="Delete Interest Rate">
                            🗑 Delete
                        </button>
                    </div>
                </td>
            </tr>
        `;
            })
            .join('');
    }

    let globalFieldsCache = null;
    let serverRateFieldValuesMap = {};

    function fetchGlobalFields() {
        if (globalFieldsCache) {
            return Promise.resolve(globalFieldsCache);
        }

        return fetch('/api/global-fields')
            .then(response => response.json())
            .then(fields => {
                globalFieldsCache = fields;
                return fields;
            })
            .catch(error => {
                console.error('Error fetching global fields:', error);
                return [];
            });
    }

    function updatePaginationControls() {
        totalPages = Math.ceil(filteredRates.length / pageSize);

        // Update navigation buttons
        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');

        if (firstPageBtn) firstPageBtn.disabled = currentPage === 1;
        if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
        if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages;
        if (lastPageBtn) lastPageBtn.disabled = currentPage === totalPages;

        // Update page numbers
        updatePageNumbers();

        // Update page jump input
        const pageJumpInput = document.getElementById('pageJumpInput');
        if (pageJumpInput) {
            pageJumpInput.max = totalPages;
            pageJumpInput.placeholder = currentPage;
        }
    }

    function updatePageNumbers() {
        const pageNumbers = document.getElementById('pageNumbers');
        const pageNumbersBottom = document.getElementById('pageNumbersBottom');

        if (!pageNumbers) return;

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        // Adjust start page if we're near the end
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        let html = '';

        for (let i = startPage; i <= endPage; i++) {
            html += `
                <button class="page-btn ${i === currentPage ? 'active' : ''}"
                        onclick="goToPage(${i})">${i}</button>
            `;
        }

        pageNumbers.innerHTML = html;
        if (pageNumbersBottom) {
            pageNumbersBottom.innerHTML = html;
        }
    }

    function updatePaginationInfo() {
        const startRecord = filteredRates.length === 0 ? 0 : (currentPage - 1) * pageSize + 1;
        const endRecord = Math.min(currentPage * pageSize, filteredRates.length);
        const totalRecords = filteredRates.length;

        const infoText = `Showing ${startRecord}-${endRecord} of ${totalRecords} results`;

        const resultsInfo = document.getElementById('resultsInfo');
        const resultsInfoBottom = document.getElementById('resultsInfoBottom');

        if (resultsInfo) resultsInfo.textContent = infoText;
        if (resultsInfoBottom) resultsInfoBottom.textContent = infoText;
    }

    function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage || isLoading) return;
        loadPage(page);
    }

    function jumpToPage() {
        const input = document.getElementById('pageJumpInput');
        const page = parseInt(input.value);

        if (page && page >= 1 && page <= totalPages) {
            goToPage(page);
            input.value = '';
        }
    }

    function changePageSize(newSize) {
        pageSize = parseInt(newSize);
        currentPage = 1; // Reset to first page
        loadPage(1);
    }

    function showLoading() {
        isLoading = true;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.add('show');
    }

    function hideLoading() {
        isLoading = false;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.remove('show');
    }

    // Enhanced delete function that updates pagination
    // Enhanced delete function with server-side pagination
    function deleteInterestRate(rateId) {
            fetch(`/interest-rate/${rateId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete interest rate');
                    }
                    return response.text();
                })
                .then(data => {
                    hideDeleteConfirmation();
                    showDeleteNotification('Interest rate deleted successfully!', false);

                    // Close any expanded card for this rate
                    closeExpandedCard(rateId);

                    // Reload current page to reflect deletion
                    const searchTerm = document.getElementById('searchInput')
                        ?.value || '';

                    // If current page becomes empty, go to previous page
                    setTimeout(() => {
                        loadPageFromServer(currentPage, searchTerm);
                    }, 500);
                })
                .catch(error => {
                    hideDeleteConfirmation();
                    showDeleteNotification('Error deleting interest rate: ' + error.message, true);
                });
        }


        // Enhanced sort function that works with pagination
        // Enhanced sort function with server-side sorting
        function sortTable(headerElement, event) {
        if (event && event.type === 'click' && headerElement.classList.contains('dragging')) {
            return;
        }

        const fieldId = headerElement.dataset.fieldId;
        const currentSortField = `field_${fieldId}`;

        let sortDirection = 'asc';
        if (currentSortColumn === currentSortField) {
            sortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        }

        // Clear previous sort indicators
        document.querySelectorAll('.sortable')
            .forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

        headerElement.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

        // Update sort state
        currentSortColumn = currentSortField;
        currentSortDirection = sortDirection;

        // Reset to first page and load with new sort
        currentPage = 1;
        const searchTerm = document.getElementById('searchInput')?.value || '';
        loadPageFromServer(1, searchTerm);

        updateSortInfo(headerElement.querySelector('.header-text').textContent.trim(), sortDirection);
    }
    document.addEventListener('DOMContentLoaded', function() {
        if (!document.getElementById('sortInfo')) {
            const sortInfo = document.createElement('div');
            sortInfo.id = 'sortInfo';
            sortInfo.className = 'sort-info';
            sortInfo.textContent = 'Click column headers to sort ↕️';

            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.parentNode.insertBefore(sortInfo, tableContainer);
            }
        }
    });

    // Enhanced updateSortInfo function
    function updateSortInfo(columnName, direction) {
        const sortInfo = document.getElementById('sortInfo');
        if (sortInfo) {
            if (columnName && direction) {
                sortInfo.innerHTML = `Sorted by: <strong>${columnName}</strong> ${direction === 'asc' ? '↑' : '↓'}
                    <button onclick="resetSort()" style="margin-left: 10px; padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; background: white; border-radius: 3px; cursor: pointer;">Reset</button>`;
                sortInfo.style.background = 'linear-gradient(135deg, #e7f3ff, #cce7ff)';
            } else {
                sortInfo.textContent = 'Click column headers to sort ↕️';
                sortInfo.style.background = 'white';
            }
        }
    }

    // Enhanced resetSort function
    function resetSort() {
        // Clear all sort indicators
        document.querySelectorAll('.sortable')
            .forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

        // Reset sort state
        currentSortColumn = null;
        currentSortDirection = null;

        // Reset to first page with no sorting
        currentPage = 1;
        const searchTerm = document.getElementById('searchInput')?.value || '';
        loadPageFromServer(1, searchTerm);

        updateSortInfo();
        showDeleteNotification('Sort reset! Data restored to original order.', false);
    }

   function initializeSearch() {
        const existingSearch = document.querySelector('.search-container');
        if (existingSearch) {
            existingSearch.remove();
        }
    }

    function performSearch() {
        const searchTerm = document.getElementById('searchInput')
            .value;
        currentPage = 1; // Reset to first page
        loadPageFromServer(1, searchTerm);
    }

    function clearSearch() {
        document.getElementById('searchInput')
            .value = '';
        currentPage = 1;
        loadPageFromServer(1, '');
    }

    // Enhanced pagination info update
    function updatePaginationInfo() {
        const startRecord = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
        const endRecord = Math.min(currentPage * pageSize, totalRecords);

        const infoText = `Showing ${startRecord}-${endRecord} of ${totalRecords} results`;

        const resultsInfo = document.getElementById('resultsInfo');
        const resultsInfoBottom = document.getElementById('resultsInfoBottom');

        if (resultsInfo) resultsInfo.textContent = infoText;
        if (resultsInfoBottom) resultsInfoBottom.textContent = infoText;
    }

    // Enhanced pagination controls update
    function updatePaginationControls() {
        // Update navigation buttons
        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');

        if (firstPageBtn) firstPageBtn.disabled = currentPage === 1;
        if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
        if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        if (lastPageBtn) lastPageBtn.disabled = currentPage === totalPages || totalPages === 0;

        // Update page numbers
        updatePageNumbers();

        // Update page jump input
        const pageJumpInput = document.getElementById('pageJumpInput');
        if (pageJumpInput) {
            pageJumpInput.max = totalPages;
            pageJumpInput.placeholder = currentPage;
        }
    }

    // Enhanced page numbers update
    function updatePageNumbers() {
        const pageNumbers = document.getElementById('pageNumbers');
        const pageNumbersBottom = document.getElementById('pageNumbersBottom');

        if (!pageNumbers) return;

        if (totalPages === 0) {
            pageNumbers.innerHTML = '';
            if (pageNumbersBottom) pageNumbersBottom.innerHTML = '';
            return;
        }

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        // Adjust start page if we're near the end
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        let html = '';

        // Add ellipsis at the beginning if needed
        if (startPage > 1) {
            html += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
            if (startPage > 2) {
                html += `<span class="page-ellipsis">...</span>`;
            }
        }

        // Add page numbers
        for (let i = startPage; i <= endPage; i++) {
            html += `
            <button class="page-btn ${i === currentPage ? 'active' : ''}"
                    onclick="goToPage(${i})">${i}</button>
        `;
        }

        // Add ellipsis at the end if needed
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += `<span class="page-ellipsis">...</span>`;
            }
            html += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
        }

        pageNumbers.innerHTML = html;
        if (pageNumbersBottom) {
            pageNumbersBottom.innerHTML = html;
        }
    }

    // Enhanced showMoreInfo that works with server data
    function showMoreInfo(rateId) {
        // Find rate in current page data first, then fall back to server call
        let rate = allInterestRates.find(r => r.id === rateId);

        if (!rate) {
            // If not found in current page, fetch from server
            fetchRateDetails(rateId)
                .then(rateData => {
                    if (rateData && rateData.moreInfo) {
                        displayRateCard(rateData);
                    }
                });
            return;
        }

        if (!rate.moreInfo) {
            showDeleteNotification('No additional information available for this rate.', false);
            return;
        }

        displayRateCard(rate);
    }

    function fetchRateDetails(rateId) {
        return fetch(`/api/interest-rate/${rateId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch rate details');
                }
                return response.json();
            })
            .catch(error => {
                console.error('Error fetching rate details:', error);
                showDeleteNotification('Error loading rate details: ' + error.message, true);
                return null;
            });
    }

    function displayRateCard(rate) {
        // Close any currently expanded card
        if (currentExpandedCard && currentExpandedCard !== rate.id) {
            closeExpandedCard(currentExpandedCard);
        }

        let existingCard = document.getElementById(`rateCardRow_${rate.id}`);
        if (existingCard) {
            // Toggle card visibility
            existingCard.style.display = 'none';
            setTimeout(() => {
                if (existingCard.parentNode) {
                    existingCard.parentNode.removeChild(existingCard);
                }
            }, 0);

            if (currentExpandedCard === rate.id) {
                currentExpandedCard = null;
                return;
            }
        }

        // Find the table row that was clicked
        const targetRow = document.querySelector(`tr[data-rate-id="${rate.id}"]`);
        if (!targetRow) return;

        const card = createRateCard(rate);

        const cardRow = document.createElement('tr');
        cardRow.id = `rateCardRow_${rate.id}`;
        cardRow.className = 'rate-card-row show';
        cardRow.innerHTML = `<td colspan="100%" class="rate-card-cell"></td>`;

        cardRow.querySelector('.rate-card-cell')
            .appendChild(card);

        targetRow.parentNode.insertBefore(cardRow, targetRow.nextSibling);

        setTimeout(() => {
            card.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 50);

        currentExpandedCard = rate.id;
    }

    // Performance optimization: Add loading states for better UX
    function showLoading() {
        isLoading = true;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.add('show');
        }

        // Disable pagination controls during loading
        const paginationButtons = document.querySelectorAll('.page-btn, #pageSize, #searchInput');
        paginationButtons.forEach(btn => {
            btn.disabled = true;
        });
    }

    function hideLoading() {
        isLoading = false;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.remove('show');
        }

        // Re-enable pagination controls
        const paginationButtons = document.querySelectorAll('.page-btn, #pageSize, #searchInput');
        paginationButtons.forEach(btn => {
            btn.disabled = false;
        });

        // Re-disable navigation buttons based on current state
        updatePaginationControls();
    }

    // Add refresh function for manual data reload
    function refreshCurrentPage() {
        const searchTerm = document.getElementById('searchInput')
            ?.value || '';
        loadPageFromServer(currentPage, searchTerm);
    }

    // Enhanced error handling
    function handleApiError(error, operation = 'operation') {
        console.error(`Error during ${operation}:`, error);

        let message = `Error during ${operation}`;
        if (error.message) {
            message += `: ${error.message}`;
        }

        showDeleteNotification(message, true);
        hideLoading();
    }

    // Add URL state management for bookmarking and back/forward navigation
    function updateUrlState() {
        const url = new URL(window.location);
        url.searchParams.set('page', currentPage);
        url.searchParams.set('size', pageSize);

        const searchTerm = document.getElementById('searchInput')
            ?.value;
        if (searchTerm) {
            url.searchParams.set('search', searchTerm);
        } else {
            url.searchParams.delete('search');
        }

        if (currentSortColumn) {
            url.searchParams.set('sortBy', currentSortColumn);
            url.searchParams.set('sortDir', currentSortDirection);
        }

        window.history.replaceState({}, '', url);
    }

    // Initialize from URL parameters
    function initializeFromUrl() {
        const url = new URL(window.location);
        const urlPage = parseInt(url.searchParams.get('page')) || 1;
        const urlSize = parseInt(url.searchParams.get('size')) || 5;
        const urlSearch = url.searchParams.get('search') || '';
        const urlSortBy = url.searchParams.get('sortBy') || '';
        const urlSortDir = url.searchParams.get('sortDir') || 'asc';

        currentPage = urlPage;
        pageSize = urlSize;
        currentSortColumn = urlSortBy;
        currentSortDirection = urlSortDir;

        // Update UI elements
        const pageSizeSelect = document.getElementById('pageSize');
        if (pageSizeSelect) {
            pageSizeSelect.value = pageSize;
        }

        const searchInput = document.getElementById('searchInput');
        if (searchInput && urlSearch) {
            searchInput.value = urlSearch;
        }
    }

    // Browser back/forward navigation support
    window.addEventListener('popstate', function (event) {
        initializeFromUrl();
        const searchTerm = document.getElementById('searchInput')
            ?.value || '';
        loadPageFromServer(currentPage, searchTerm);
    });

    // Auto-save functionality for field value changes
    let autoSaveTimeout;

    function scheduleAutoSave(rateId, fieldId, value) {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            updateFieldValueAjax(rateId, fieldId, value);
        }, 1000); // Save after 1 second of no changes
    }

    // Enhanced field value update with visual feedback
    function updateFieldValueAjax(rateId, fieldId, value) {
        const input = document.querySelector(`input[name="rateId"][value="${rateId}"]`)
            ?.parentElement
            ?.querySelector(`input[name="fieldId"][value="${fieldId}"]`)
            ?.parentElement
            ?.querySelector('input[name="value"]');

        if (input) {
            input.classList.add('saving');
        }

        const formData = new FormData();
        formData.append('rateId', rateId);
        formData.append('fieldId', fieldId);
        formData.append('value', value);

        fetch('/field-values/update', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update field value');
                }

                // Update local cache
                if (!serverRateFieldValuesMap[rateId]) {
                    serverRateFieldValuesMap[rateId] = {};
                }
                serverRateFieldValuesMap[rateId][fieldId] = value;

                if (input) {
                    input.classList.remove('saving');
                    input.classList.add('saved');
                    setTimeout(() => {
                        input.classList.remove('saved');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error updating field value:', error);
                if (input) {
                    input.classList.remove('saving');
                    input.classList.add('error');
                    setTimeout(() => {
                        input.classList.remove('error');
                    }, 3000);
                }
                showDeleteNotification('Error updating field value: ' + error.message, true);
            });
    }

    // Bulk operations support
    function selectAllRows() {
        const checkboxes = document.querySelectorAll('.row-select');
        const selectAllCheckbox = document.getElementById('selectAll');

        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });

        updateBulkActionButtons();
    }

    function updateBulkActionButtons() {
        const selectedRows = document.querySelectorAll('.row-select:checked');
        const bulkActionContainer = document.getElementById('bulkActions');

        if (bulkActionContainer) {
            bulkActionContainer.style.display = selectedRows.length > 0 ? 'block' : 'none';
        }
    }

    // Export functionality
    function exportCurrentPage() {
        const searchTerm = document.getElementById('searchInput')
            ?.value || '';
        const params = new URLSearchParams({
            page: currentPage - 1,
            size: pageSize,
            sortBy: currentSortColumn || 'id',
            sortDir: currentSortDirection || 'asc',
            format: 'csv'
        });

        if (searchTerm.trim()) {
            params.append('search', searchTerm.trim());
        }

        window.location.href = `/api/interest-rates/export?${params.toString()}`;
    }

    // Initialize everything when DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        initializeFromUrl();
        initializePagination();
        captureOriginalOrder();
        initializeSortableHeaders();
        initializeResponsiveToggle();
        initializeScrollIndicator();
        initializeSearch();

        // Load initial page from server
        const searchTerm = document.getElementById('searchInput')
            ?.value || '';
        loadPageFromServer(currentPage, searchTerm);

        // Update URL state on changes
        setInterval(updateUrlState, 2000); // Update URL every 2 seconds if needed
    });

    function updateSortInfo(columnName, direction) {
        const sortInfo = document.getElementById('sortInfo');
        if (sortInfo) {
            if (columnName && direction) {
                sortInfo.innerHTML = `Sorted by: <strong>${columnName}</strong> ${direction === 'asc' ? '↑' : '↓'}`;
                sortInfo.style.background = 'linear-gradient(135deg, #e7f3ff, #cce7ff)';
            } else {
                sortInfo.textContent = 'Click column headers to sort ↕️';
                sortInfo.style.background = 'white';
            }
        }
    }

    // Enhanced search function (if you want to add search later)
    function searchInterestRates(searchTerm) {
        if (!searchTerm.trim()) {
            filteredRates = [...allInterestRates];
        } else {
            const rateFieldValuesMap = /*[[${rateFieldValuesMap}]]*/ {};
            filteredRates = allInterestRates.filter(rate => {
                // Search in all field values
                if (rateFieldValuesMap[rate.id]) {
                    return Object.values(rateFieldValuesMap[rate.id])
                        .some(value =>
                            value && value.toString()
                            .toLowerCase()
                            .includes(searchTerm.toLowerCase())
                        );
                }

                // Also search in webLink if available
                if (rate.webLink && rate.webLink.toLowerCase()
                    .includes(searchTerm.toLowerCase())) {
                    return true;
                }

                return false;
            });
        }

        // Reset to first page after search
        currentPage = 1;
        loadPage(1);
    }

    // All your existing functions remain the same, just adding pagination-aware versions


    // AJAX field value update
    function updateFieldValueAjax(rateId, fieldId, value) {
        const formData = new FormData();
        formData.append('rateId', rateId);
        formData.append('fieldId', fieldId);
        formData.append('value', value);

        fetch('/field-values/update', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update field value');
                }
                // Update local cache
                if (!serverRateFieldValuesMap[rateId]) {
                    serverRateFieldValuesMap[rateId] = {};
                }
                serverRateFieldValuesMap[rateId][fieldId] = value;
            })
            .catch(error => {
                console.error('Error updating field value:', error);
                showDeleteNotification('Error updating field value: ' + error.message, true);
            });
    }

    // Enhanced pagination functions
    function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage || isLoading) return;

        const searchTerm = document.getElementById('searchInput')
            ?.value || '';
        loadPageFromServer(page, searchTerm);
    }

    function changePageSize(newSize) {
        pageSize = parseInt(newSize);
        currentPage = 1; // Reset to first page

        const searchTerm = document.getElementById('searchInput')
            ?.value || '';
        loadPageFromServer(1, searchTerm);
    }

    function jumpToPage() {
        const input = document.getElementById('pageJumpInput');
        const page = parseInt(input.value);

        if (page && page >= 1 && page <= totalPages) {
            goToPage(page);
            input.value = '';
        }
    }

    function initializeScrollIndicator() {
        const tableContainer = document.getElementById('tableContainer');
        const scrollIndicator = document.getElementById('scrollIndicator');

        if (tableContainer && scrollIndicator) {
            function checkScrollNeeded() {
                const table = document.getElementById('mainTable');
                if (table && tableContainer.scrollWidth > tableContainer.clientWidth) {
                    scrollIndicator.classList.add('show');

                    setTimeout(() => {
                        scrollIndicator.classList.remove('show');
                    }, 3000);
                }
            }

            setTimeout(checkScrollNeeded, 500);
            window.addEventListener('resize', checkScrollNeeded);

            tableContainer.addEventListener('scroll', () => {
                scrollIndicator.classList.remove('show');
            });
        }
    }

    function initializeResponsiveToggle() {
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');
        const tableContainer = document.getElementById('tableContainer');

        if (stackedViewBtn && scrollViewBtn) {
            stackedViewBtn.addEventListener('click', function () {
                tableContainer.classList.add('mobile-stack');
                stackedViewBtn.classList.add('active');
                scrollViewBtn.classList.remove('active');
            });

            scrollViewBtn.addEventListener('click', function () {
                tableContainer.classList.remove('mobile-stack');
                scrollViewBtn.classList.add('active');
                stackedViewBtn.classList.remove('active');
            });

            // Set default view for mobile
            if (window.innerWidth <= 768) {
                tableContainer.classList.add('mobile-stack');
            }
        }
    }

    function initializeSortableHeaders() {
        // Add sortable class to all draggable columns
        const headers = document.querySelectorAll('.draggable-column');
        headers.forEach(header => {
            header.classList.add('sortable');
        });
    }

    function resetSort() {
        // Clear all sort indicators
        document.querySelectorAll('.sortable')
            .forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

        // Reset sort state
        currentSortColumn = null;
        currentSortDirection = null;

        // Reset data to original order
        filteredRates = [...allInterestRates];

        // Reset to first page
        currentPage = 1;
        loadPage(1);

        updateSortInfo();
        showDeleteNotification('Sort reset! Data restored to original order.', false);
    }

    // Keep all your existing functions but add DataTable integration where needed
    function captureOriginalOrder() {
        const headers = document.querySelectorAll('.draggable-column');
        originalOrder = Array.from(headers)
            .map(header => header.dataset.fieldId);
    }

    function handleFieldDeleteClick(button) {
        const fieldId = button.dataset.id;
        const fieldLabel = button.dataset.label;
        showFieldDeleteConfirmation(fieldId, fieldLabel);
    }

    function showFieldDeleteConfirmation(fieldId, fieldLabel) {
        pendingFieldDeleteId = fieldId;
        document.getElementById('fieldToDeleteName')
            .textContent = fieldLabel;
        document.getElementById('fieldToDeleteId')
            .textContent = fieldId;
        document.getElementById('fieldDeleteConfirmationModal')
            .style.display = 'flex';

        document.getElementById('confirmFieldDeleteBtn')
            .onclick = function () {
                deleteGlobalField(fieldId);
            };
    }

    function hideFieldDeleteConfirmation() {
        document.getElementById('fieldDeleteConfirmationModal')
            .style.display = 'none';
        pendingFieldDeleteId = null;
    }

    function deleteGlobalField(fieldId) {
        const confirmBtn = document.getElementById('confirmFieldDeleteBtn');
        const originalText = confirmBtn.textContent;
        confirmBtn.textContent = 'Deleting...';
        confirmBtn.disabled = true;

        fetch(`/fields/delete/${fieldId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete field');
                }
                return response.text();
            })
            .then(data => {
                hideFieldDeleteConfirmation();

                showDeleteNotification('Field deleted successfully! Page will reload...', false);

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                // Reset button
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;

                showDeleteNotification('Error deleting field: ' + error.message, true);
            });
    }

    // Interest rate delete functionality
    function showDeleteConfirmation(rateId) {
        pendingDeleteId = rateId;
        document.getElementById('deleteConfirmationModal')
            .style.display = 'flex';

        // Set up the confirm button click handler
        document.getElementById('confirmDeleteBtn')
            .onclick = function () {
                deleteInterestRate(rateId);
            };
    }

    function hideDeleteConfirmation() {
        document.getElementById('deleteConfirmationModal')
            .style.display = 'none';
        pendingDeleteId = null;
    }

    function showDeleteNotification(message, isError) {
        const notification = document.getElementById('deleteNotification');
        notification.textContent = message;
        notification.classList.toggle('error', isError);
        notification.classList.toggle('success', !isError);
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // Close modals when clicking outside
    document.getElementById('deleteConfirmationModal')
        .addEventListener('click', function (e) {
            if (e.target === this) {
                hideDeleteConfirmation();
            }
        });

    document.getElementById('fieldDeleteConfirmationModal')
        .addEventListener('click', function (e) {
            if (e.target === this) {
                hideFieldDeleteConfirmation();
            }
        });

    // Column drag and drop functionality
    function handleDragStart(event) {
        draggedElement = event.target;
        event.target.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/html', event.target.outerHTML);
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        const target = event.target.closest('.draggable-column');
        if (target && target !== draggedElement) {
            // Remove existing drag-over class
            document.querySelectorAll('.drag-over')
                .forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');

            // Show drop indicator
            showDropIndicator(target, event);
        }
    }

    function handleDrop(event) {
        event.preventDefault();

        const target = event.target.closest('.draggable-column');
        if (target && target !== draggedElement) {
            const draggedFieldId = draggedElement.dataset.fieldId;
            const targetFieldId = target.dataset.fieldId;

            // Move the column
            moveColumn(draggedFieldId, targetFieldId);

            // Mark order as changed
            markOrderChanged();
        }

        // Clean up
        cleanup();
    }

    function handleDragEnd(event) {
        cleanup();
    }

    function cleanup() {
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
        }
        document.querySelectorAll('.drag-over')
            .forEach(el => el.classList.remove('drag-over'));
        hideDropIndicator();
        draggedElement = null;
    }

    function moveColumn(draggedFieldId, targetFieldId) {
        const headerRow = document.getElementById("column-header-row");
        const headers = Array.from(headerRow.querySelectorAll(".draggable-column"));

        const draggedIndex = headers.findIndex(h => h.dataset.fieldId === draggedFieldId);
        const targetIndex = headers.findIndex(h => h.dataset.fieldId === targetFieldId);

        if (draggedIndex === -1 || targetIndex === -1 || draggedIndex === targetIndex) return;

        // Move header
        const draggedHeader = headers[draggedIndex];
        if (targetIndex < draggedIndex) {
            headerRow.insertBefore(draggedHeader, headers[targetIndex]);
        } else {
            headerRow.insertBefore(draggedHeader, headers[targetIndex].nextSibling);
        }

        // Immediately re-render the current page data to match new column order
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageData = filteredRates.slice(startIndex, endIndex);

        // Re-render table data with new column order
        const tbody = document.getElementById('tableBody');
        renderTableRows(pageData, tbody);
    }

    function markOrderChanged() {
        orderChanged = true;
        document.getElementById("saveOrderBtn")
            .classList.add("show");
        document.getElementById("orderChangedIndicator")
            .classList.add("show");
    }

    function saveColumnOrder() {
        const headers = document.querySelectorAll(".draggable-column");
        const newOrder = Array.from(headers)
            .map(header => header.dataset.fieldId);

        // Add visual feedback
        const saveBtn = document.getElementById("saveOrderBtn");
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "Saving...";
        saveBtn.disabled = true;

        fetch('/fields/reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': getCsrfToken()
                },
                body: JSON.stringify(newOrder)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to save order");
                }
                return response.text();
            })
            .then(data => {
                orderChanged = false;
                saveBtn.classList.remove("show");
                document.getElementById("orderChangedIndicator")
                    .classList.remove("show");

                // Update cache to match new order
                updateGlobalFieldsCache();

                // Show success message
                showDeleteNotification('Column order saved successfully!', false);

                // Reset button state
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            })
            .catch(error => {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                showDeleteNotification("Error saving order: " + error.message, true);
            });
    }

    function updateGlobalFieldsCache() {
        const headers = document.querySelectorAll('.draggable-column');
        const currentOrder = Array.from(headers)
            .map(header => ({
                id: header.dataset.fieldId,
                label: header.querySelector('.header-text')
                    .textContent
            }));

        // Reorder globalFieldsCache to match DOM order
        if (globalFieldsCache) {
            globalFieldsCache = currentOrder.map(orderItem =>
                    globalFieldsCache.find(field => field.id == orderItem.id)
                )
                .filter(Boolean);
        }
    }

    // Optional: CSRF token extraction if needed for Spring Security
    function getCsrfToken() {
        const tokenMeta = document.querySelector('meta[name="_csrf"]');
        return tokenMeta ? tokenMeta.getAttribute('content') : '';
    }

    function showDropIndicator(target, event) {
        const indicator = document.getElementById("dropIndicator");
        const rect = target.getBoundingClientRect();
        indicator.style.left = `${rect.left}px`;
        indicator.style.top = `${rect.top}px`;
        indicator.style.height = `${rect.height}px`;
        indicator.classList.add("show");
    }

    function hideDropIndicator() {
        document.getElementById("dropIndicator")
            .classList.remove("show");
    }

    // Section drag and drop functions - FIXED VERSION
    function handleSectionDragStart(event, sectionIdentifier, rateId) {
        draggedSection = {
            element: event.target.closest('.expanded-section'),
            identifier: sectionIdentifier,
            rateId: rateId
        };
        draggedSection.element.classList.add('dragging');
        currentRateId = rateId;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', sectionIdentifier);
    }

    function handleSectionDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        const target = event.target.closest('.expanded-section');
        if (target && draggedSection && target !== draggedSection.element &&
            target.closest(`#rateCard_${currentRateId}`)) {

            // Remove existing drag-over class
            document.querySelectorAll('.drag-over')
                .forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');
        }
    }

    function handleSectionDrop(event, targetIdentifier, rateId) {
        event.preventDefault();

        if (draggedSection && draggedSection.rateId === rateId && draggedSection.identifier !== targetIdentifier) {
            const sourceElement = draggedSection.element;
            const targetElement = event.target.closest('.expanded-section');

            if (sourceElement && targetElement) {
                // Get the parent container (should be the rate card content)
                const parent = sourceElement.parentElement;

                // Determine if we should insert before or after the target
                const sourceIndex = Array.from(parent.children)
                    .indexOf(sourceElement);
                const targetIndex = Array.from(parent.children)
                    .indexOf(targetElement);

                if (sourceIndex < targetIndex) {
                    // Moving down - insert after target
                    parent.insertBefore(sourceElement, targetElement.nextSibling);
                } else {
                    // Moving up - insert before target
                    parent.insertBefore(sourceElement, targetElement);
                }

                // Get new order from DOM - only count sections with data-section-id
                const sections = parent.querySelectorAll('[data-section-id]');
                const newOrder = Array.from(sections)
                    .map(el => el.getAttribute('data-section-id'));

                // Update the order in the database
                saveSectionOrder(rateId, newOrder);
            }
        }

        // Clean up
        cleanupSectionDrag();
    }

    function handleSectionDragEnd(event) {
        cleanupSectionDrag();
    }

    function cleanupSectionDrag() {
        if (draggedSection && draggedSection.element) {
            draggedSection.element.classList.remove('dragging');
        }
        document.querySelectorAll('.drag-over')
            .forEach(el => el.classList.remove('drag-over'));
        draggedSection = null;
        currentRateId = null;
    }

    // Save section order - single implementation
    function saveSectionOrder(rateId, newOrder) {
        fetch(`/sections/reorder?rateId=${rateId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newOrder)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to save section order");
                }
                return response.text();
            })
            .catch(error => {
                showDeleteNotification("Error saving section order: " + error.message, true);
            });
    }

    function showMoreInfo(rateId) {
        const rate = filteredRates.find(r => r.id === rateId) || allInterestRates.find(r => r.id === rateId);
        if (!rate || !rate.moreInfo) return;

        // Close any currently expanded card
        if (currentExpandedCard && currentExpandedCard !== rateId) {
            closeExpandedCard(currentExpandedCard);
        }

        let existingCard = document.getElementById(`rateCardRow_${rateId}`);
        if (existingCard) {
            // FIXED: Properly remove the card and clean up
            existingCard.style.display = 'none';
            setTimeout(() => {
                if (existingCard.parentNode) {
                    existingCard.parentNode.removeChild(existingCard);
                }
            }, 0);

            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
                return;
            }
        }

        // Find the table row that was clicked
        const tableRows = document.querySelectorAll('tbody tr');
        let targetRow = null;

        tableRows.forEach(row => {
            const button = row.querySelector('.mehr-info-btn');
            if (button && button.onclick && button.onclick.toString()
                .includes(`showMoreInfo(${rateId})`)) {
                targetRow = row;
            }
        });

        if (!targetRow) return;

        const card = createRateCard(rate);

        const cardRow = document.createElement('tr');
        cardRow.id = `rateCardRow_${rateId}`;
        cardRow.className = 'rate-card-row show';
        cardRow.innerHTML = `<td colspan="100%" class="rate-card-cell"></td>`;

        cardRow.querySelector('.rate-card-cell')
            .appendChild(card);

        targetRow.parentNode.insertBefore(cardRow, targetRow.nextSibling);

        setTimeout(() => {
            card.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 50);

        currentExpandedCard = rateId;
    }

    function createRateCard(rate) {
        const card = document.createElement('div');
        card.className = 'rate-card';
        card.id = `rateCard_${rate.id}`;

        const moreInfo = rate.moreInfo;
        if (!moreInfo) return card;

        // Get the section order from the data, default to empty array
        const sectionOrder = moreInfo.sectionOrder || [];

        // Create section content maps
        const tableSectionsMap = new Map();
        const textSectionsMap = new Map();

        // Map table sections by identifier
        if (moreInfo.tableSections) {
            moreInfo.tableSections.forEach(tableSection => {
                tableSectionsMap.set(tableSection.sectionIdentifier, tableSection);
            });
        }

        // Map text sections by identifier
        if (moreInfo.textSections) {
            moreInfo.textSections.forEach(textSection => {
                textSectionsMap.set(textSection.sectionIdentifier, textSection);
            });
        }

        // Helper function to create table sections
        const createTableSection = (tableSection) => {
            if (!tableSection || !tableSection.title || !tableSection.miniTableRows || tableSection.miniTableRows.length === 0) {
                return '';
            }
            return `
                    <div class="expanded-section draggable-section table-section"
                         draggable="true"
                         data-section-type="table"
                         data-section-id="${tableSection.sectionIdentifier}"
                         ondragstart="handleSectionDragStart(event, '${tableSection.sectionIdentifier}', ${rate.id})"
                         ondragover="handleSectionDragOver(event)"
                         ondrop="handleSectionDrop(event, '${tableSection.sectionIdentifier}', ${rate.id})"
                         ondragend="handleSectionDragEnd(event)">
                        <div class="section-drag-handle" title="Drag to reorder">⋮⋮</div>
                        <div class="section-controls">
                            <span class="section-type-indicator">Table</span>
                        </div>
                        <h5 class="section-title">${tableSection.title}</h5>
                        <div class="info-table">
                            ${tableSection.miniTableRows.map(row => `
                                <div class="info-table-row">
                                    <div class="info-table-label">${row.label || ''}</div>
                                    <div class="info-table-value">${row.description || ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
        };

        // Helper function to create text sections
        const createTextSection = (textSection) => {
            if (!textSection || (!textSection.title && !textSection.content)) {
                return '';
            }
            return `
                    <div class="expanded-section draggable-section text-section"
                         draggable="true"
                         data-section-type="text"
                         data-section-id="${textSection.sectionIdentifier}"
                         ondragstart="handleSectionDragStart(event, '${textSection.sectionIdentifier}', ${rate.id})"
                         ondragover="handleSectionDragOver(event)"
                         ondrop="handleSectionDrop(event, '${textSection.sectionIdentifier}', ${rate.id})"
                         ondragend="handleSectionDragEnd(event)">
                        <div class="section-drag-handle" title="Drag to reorder">⋮⋮</div>
                        <div class="section-controls">
                            <span class="section-type-indicator">Text</span>
                        </div>
                        ${textSection.title ? `<h5 class="section-title">${textSection.title}</h5>` : ''}
                        <div class="text-content" style="text-align: left;">${textSection.content || ''}</div>
                    </div>
                `;
        };

        // Build sections in the correct order
        let sectionsHTML = '';
        sectionOrder.forEach(sectionIdentifier => {
            if (sectionIdentifier.startsWith('table-')) {
                const tableSection = tableSectionsMap.get(sectionIdentifier);
                if (tableSection) {
                    sectionsHTML += createTableSection(tableSection);
                }
            } else if (sectionIdentifier.startsWith('text-')) {
                const textSection = textSectionsMap.get(sectionIdentifier);
                if (textSection) {
                    sectionsHTML += createTextSection(textSection);
                }
            }
        });

        // Add any sections not in the order (fallback)
        tableSectionsMap.forEach((tableSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTableSection(tableSection);
            }
        });

        textSectionsMap.forEach((textSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTextSection(textSection);
            }
        });

        card.innerHTML = `
                <div class="rate-expanded-content show">
                    ${sectionsHTML}
                </div>
            `;

        return card;
    }

    function closeExpandedCard(rateId) {
        const cardRow = document.getElementById(`rateCardRow_${rateId}`);
        if (cardRow) {
            // FIXED: Properly hide and remove the card to prevent white space
            cardRow.style.display = 'none';
            cardRow.classList.remove('show');

            // Use requestAnimationFrame to ensure proper cleanup
            requestAnimationFrame(() => {
                if (cardRow.parentNode) {
                    cardRow.parentNode.removeChild(cardRow);
                }
            });

            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
            }
        }
    }

    function showEditForm(fieldId) {
        if (currentEditForm) {
            currentEditForm.classList.remove('show');
        }
        const form = document.getElementById('editForm_' + fieldId);
        if (form) {
            form.classList.add('show');
            currentEditForm = form;
        }
    }

    function hideEditForm(fieldId) {
        const form = document.getElementById('editForm_' + fieldId);
        if (form) {
            form.classList.remove('show');
        }
        currentEditForm = null;
    }

    document.addEventListener('click', function (e) {
        if (currentEditForm && !currentEditForm.contains(e.target) && !e.target.classList.contains('edit-header-btn')) {
            currentEditForm.classList.remove('show');
            currentEditForm = null;
        }
    });

    // Enhanced keyboard navigation for pagination
    document.addEventListener('keydown', function (e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        switch (e.key) {
        case 'ArrowLeft':
            if (currentPage > 1) {
                e.preventDefault();
                goToPage(currentPage - 1);
            }
            break;
        case 'ArrowRight':
            if (currentPage < totalPages) {
                e.preventDefault();
                goToPage(currentPage + 1);
            }
            break;
        case 'Home':
            e.preventDefault();
            goToPage(1);
            break;
        case 'End':
            e.preventDefault();
            goToPage(totalPages);
            break;
        }
    });

    // Handle Enter key in page jump input
    document.getElementById('pageJumpInput')
        .addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                jumpToPage();
            }
        });

    window.addEventListener('resize', function () {
        const tableContainer = document.getElementById('tableContainer');
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');

        if (window.innerWidth > 768) {
            tableContainer.classList.remove('mobile-stack');
            if (stackedViewBtn) stackedViewBtn.style.display = 'none';
            if (scrollViewBtn) scrollViewBtn.style.display = 'none';
        } else {
            if (stackedViewBtn) stackedViewBtn.style.display = 'inline-block';
            if (scrollViewBtn) scrollViewBtn.style.display = 'inline-block';

            if (!tableContainer.classList.contains('mobile-stack') &&
                stackedViewBtn && stackedViewBtn.classList.contains('active')) {
                tableContainer.classList.add('mobile-stack');
            }
        }
    });
</script>
</body>
</html>