<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interest Rate Offers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/index.css">
</head>
<body class="bg-light" th:classappend="${#authorization.expression('isAuthenticated()')} ? 'authenticated' : 'guest'">
<div class="container py-4">

    <!-- Authentication Status Section -->
    <div sec:authorize="isAuthenticated()" class="auth-section">
        <div class="user-info">
            <div>
                <strong>Welcome, <span sec:authentication="name">User</span>!</strong>
                <span class="text-muted">• Administrator Mode</span>
            </div>
            <div>
                <a href="/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
            </div>
        </div>
    </div>

    <!-- Guest Notice -->
    <div sec:authorize="!isAuthenticated()" class="guest-notice">
        <div class="alert-heading"><strong>👁️ Read-Only Mode</strong></div>
        <p class="mb-2">You are viewing this page as a guest. All data is read-only.</p>
        <p class="mb-0">
            <a href="/login" class="btn btn-primary btn-sm me-2">Login</a>
            <a href="/register" class="btn btn-outline-primary btn-sm">Register</a>
            to access administrative features.
        </p>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div class="d-flex align-items-center flex-wrap">
            <h2 class="me-3 mb-2 mb-md-0">Interest Rate Offers</h2>
            <!-- Admin-only order change indicator -->
            <span class="order-changed-indicator admin-only" id="orderChangedIndicator">
                Order changed - click save to persist
            </span>
            <button class="save-order-btn admin-only" id="saveOrderBtn" onclick="saveColumnOrder()">
                Save Order
            </button>
        </div>
        <!-- Admin-only add button -->
        <a class="btn btn-primary mt-2 mt-md-0 admin-only" href="/interest-rate/new" sec:authorize="isAuthenticated()">+ Add New Interest Rate</a>
    </div>

    <!-- Admin-only form to add global fields -->
    <form class="mb-4 admin-only" method="post" th:action="@{/fields/add}" th:object="${newField}" sec:authorize="isAuthenticated()">
        <div class="row g-2">
            <div class="col-md-6 col-lg-4">
                <input class="form-control" placeholder="Label (e.g. Max Deposit)" th:field="*{label}"/>
            </div>
            <div class="col-md-6 col-lg-4">
                <button class="btn btn-primary w-100">Add Field</button>
            </div>
        </div>
    </form>

    <!-- View Toggle for Mobile -->
    <div class="view-toggle d-md-none">
        <div class="btn-group" role="group" aria-label="View toggle">
            <button type="button" class="btn btn-outline-primary active" id="stackedView">
                📱 Card View
            </button>
            <button type="button" class="btn btn-outline-primary" id="scrollView">
                📊 Table View
            </button>
        </div>
    </div>

    <!-- Pagination Controls - Top -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="results-info" id="resultsInfo">
                Showing 1-5 of 25 results
            </div>
            <div class="page-size-selector">
                <label for="pageSize">Show:</label>
                <select id="pageSize" onchange="changePageSize(this.value)">
                    <option value="5" selected>5 per page</option>
                    <option value="10">10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                </select>
            </div>
        </div>

        <div class="pagination-controls">
            <div class="quick-nav">
                <button class="page-btn" id="firstPageBtn" onclick="goToPage(1)" title="First page">⏮</button>
                <button class="page-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)" title="Previous page">‹</button>
            </div>

            <div id="pageNumbers" class="quick-nav">
                <!-- Page numbers will be generated here -->
            </div>

            <div class="quick-nav">
                <button class="page-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)" title="Next page">›</button>
                <button class="page-btn" id="lastPageBtn" onclick="goToPage(totalPages)" title="Last page">⏭</button>
            </div>

            <div class="pagination-jump">
                <span>Go to:</span>
                <input type="number" id="pageJumpInput" class="page-input" min="1" placeholder="1">
                <button class="page-btn" onclick="jumpToPage()">Go</button>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>

        <div class="scroll-indicator" id="scrollIndicator">← Scroll horizontally to see more →</div>

        <div class="table-responsive" id="tableContainer">
            <table class="table table-sm" id="mainTable">
                <thead class="table">
                <tr id="column-header-row">
                    <th th:each="field, iterStat : ${globalFields}"
                        th:class="${#authorization.expression('isAuthenticated()')} ? 'draggable-column sortable' : 'sortable'"
                        th:draggable="${#authorization.expression('isAuthenticated()')}"
                        th:attr="ondragend=${#authorization.expression('isAuthenticated()')} ? 'handleDragEnd(event)' : null,
                                 ondragover=${#authorization.expression('isAuthenticated()')} ? 'handleDragOver(event)' : null,
                                 ondragstart=${#authorization.expression('isAuthenticated()')} ? 'handleDragStart(event)' : null,
                                 ondrop=${#authorization.expression('isAuthenticated()')} ? 'handleDrop(event)' : null"
                        onclick="sortTable(this, event)"
                        th:data-field-id="${field.id}"
                        th:data-column-index="${iterStat.index}">

                        <!-- Admin-only drag handle -->
                        <div class="drag-handle admin-only" sec:authorize="isAuthenticated()">⋮⋮</div>

                        <div class="header-container">
                            <span class="header-text" th:text="${field.label}"></span>
                            <!-- Admin-only edit and delete buttons -->
                            <button class="edit-header-btn admin-only"
                                    th:onclick="'showEditForm(' + ${field.id} + ')'"
                                    type="button"
                                    sec:authorize="isAuthenticated()">
                                ✎
                            </button>
                            <button class="delete-field-btn admin-only"
                                    th:data-id="${field.id}"
                                    th:data-label="${field.label}"
                                    onclick="handleFieldDeleteClick(this)"
                                    type="button"
                                    title="Delete this field"
                                    sec:authorize="isAuthenticated()">
                                🗑
                            </button>

                            <!-- Admin-only edit form -->
                            <div class="header-edit-form admin-only" th:id="'editForm_' + ${field.id}" sec:authorize="isAuthenticated()">
                                <form method="post" th:action="@{/fields/update}">
                                    <input name="fieldId" th:value="${field.id}" type="hidden"/>

                                    <div class="form-row">
                                        <label>Display Label:</label>
                                        <input name="label" required th:value="${field.label}" type="text"/>
                                    </div>

                                    <div class="form-buttons">
                                        <button class="save-btn" type="submit">Save</button>
                                        <button class="cancel-btn" th:onclick="'hideEditForm(' + ${field.id} + ')'"
                                                type="button">Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </th>
                    <th class="no-drag">Actions</th>
                </tr>
                </thead>

                <tbody id="tableBody">
                <!-- Data rows will be populated by JavaScript -->
                </tbody>
            </table>

            <!-- Empty state -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div>📊</div>
                <h5>No interest rates found</h5>
                <p>Try adjusting your search criteria or add a new interest rate.</p>
            </div>
        </div>
    </div>

    <!-- Pagination Controls - Bottom -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="results-info" id="resultsInfoBottom">
                Showing 1-5 of 25 results
            </div>
        </div>

        <div class="pagination-controls">
            <div class="quick-nav">
                <button class="page-btn" onclick="goToPage(1)" title="First page">⏮</button>
                <button class="page-btn" onclick="goToPage(currentPage - 1)" title="Previous page">‹</button>
            </div>

            <div id="pageNumbersBottom" class="quick-nav">
                <!-- Page numbers will be generated here -->
            </div>

            <div class="quick-nav">
                <button class="page-btn" onclick="goToPage(currentPage + 1)" title="Next page">›</button>
                <button class="page-btn" onclick="goToPage(totalPages)" title="Last page">⏭</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin-only modals -->
<div sec:authorize="isAuthenticated()">
    <!-- Field Delete Confirmation Modal -->
    <div class="delete-confirmation-modal" id="fieldDeleteConfirmationModal">
        <div class="delete-confirmation-content">
            <h5>⚠️ Delete Field</h5>
            <div class="field-info">
                <p><strong>Field:</strong> <span id="fieldToDeleteName">Field Name</span></p>
                <p><strong>ID:</strong> <span id="fieldToDeleteId">Field ID</span></p>
            </div>
            <p>Are you sure you want to delete this field (column)?</p>
            <div class="warning-text">
                ⚠️ This will permanently remove the field and ALL associated data for every interest rate!
            </div>
            <p><strong>This action cannot be undone.</strong></p>

            <div class="delete-confirmation-buttons">
                <button class="btn btn-danger" id="confirmFieldDeleteBtn">Yes, Delete Field</button>
                <button class="btn btn-secondary" onclick="hideFieldDeleteConfirmation()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Interest Rate Delete Confirmation Modal -->
    <div class="delete-confirmation-modal" id="deleteConfirmationModal">
        <div class="delete-confirmation-content">
            <h5>⚠️ Confirm Deletion</h5>
            <p>Are you sure you want to delete this interest rate?</p>
            <p><strong>This action cannot be undone.</strong></p>

            <div class="delete-confirmation-buttons">
                <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
                <button class="btn btn-secondary" onclick="hideDeleteConfirmation()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Drop indicator -->
    <div class="drop-indicator" id="dropIndicator"></div>

    <!-- Delete notification -->
    <div class="delete-notification" id="deleteNotification">
        Action completed successfully!
    </div>
</div>

<!-- Include jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script th:inline="javascript">
    // Add authentication state to JavaScript
    const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;

    // All your existing JavaScript variables and functions remain the same
    let currentPage = 1;
    let pageSize = 5;
    let totalRecords = 0;
    let totalPages = 0;
    let allInterestRates = /*[[${interestRates}]]*/ [];
    let filteredRates = [];
    let isLoading = false;

    // Keep all your existing variables
    let currentExpandedCard = null;
    let currentEditForm = null;
    let draggedElement = null;
    let orderChanged = false;
    let originalOrder = [];
    let pendingDeleteId = null;
    let pendingFieldDeleteId = null;
    let draggedSection = null;
    let currentRateId = null;
    let currentSortColumn = null;
    let currentSortDirection = null;

    document.addEventListener('DOMContentLoaded', function () {
        initializePagination();
        if (isAuthenticated) {
            captureOriginalOrder();
        }
        initializeSortableHeaders(); // Move this outside the if block
        initializeSearch();
        loadPageFromServer(1);
    });

    // Modified renderTableRows function to handle authentication
    function renderTableRows(data, tbody) {
        tbody.innerHTML = data.map(rate => {
            const headers = document.querySelectorAll('.draggable-column, .sortable');
            const currentFieldOrder = Array.from(headers)
                .map(header => ({
                    id: header.dataset.fieldId,
                    label: header.querySelector('.header-text').textContent
                }));

            const fieldCells = currentFieldOrder.map(field => {
                const fieldValue = serverRateFieldValuesMap[rate.id]?.[field.id] || '';

                // For authenticated users, show editable inputs
                if (isAuthenticated) {
                    return `
                        <td class="data-cell" data-field-id="${field.id}" data-label="${field.label}">
                            <form class="d-flex justify-content-center" method="post" action="/field-values/update">
                                <input name="rateId" value="${rate.id}" type="hidden"/>
                                <input name="fieldId" value="${field.id}" type="hidden"/>
                                <input class="form-control form-control-sm text-center"
                                       name="value"
                                       value="${fieldValue}"
                                       type="text"
                                       onchange="updateFieldValueAjax(${rate.id}, ${field.id}, this.value)"/>
                            </form>
                        </td>
                    `;
                } else {
                    // For guests, show read-only values
                    // For guests, show read-only values
                    return `
                        <td class="data-cell" data-field-id="${field.id}" data-label="${field.label}">
                            <div class="form-control form-control-sm text-center" style="border: none; background: transparent; cursor: default;">${fieldValue || '-'}</div>
                        </td>
                    `;
                }
            }).join('');

            // Action buttons - different for authenticated vs guest users
            let actionButtons = '';
            if (isAuthenticated) {
                actionButtons = `
                    <div class="action-buttons">
                        <button class="mehr-info-btn"
                                ${rate.moreInfo ? '' : 'disabled'}
                                onclick="showMoreInfo(${rate.id})"
                                title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}">
                            ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                        </button>
                        <a class="angebot-btn"
                           href="${rate.webLink || '#'}"
                           target="_blank"
                           title="Open Link">
                            ZUM ANGEBOT
                        </a>
                        <a class="btn-edit" href="/interest-rate/edit/${rate.id}" title="Edit Interest Rate">
                            ✎ Edit
                        </a>
                        <button class="btn-delete"
                                onclick="showDeleteConfirmation(${rate.id})"
                                title="Delete Interest Rate">
                            🗑 Delete
                        </button>
                    </div>
                `;
            } else {
                actionButtons = `
                    <div class="action-buttons">
                        <button class="mehr-info-btn"
                                ${rate.moreInfo ? '' : 'disabled'}
                                onclick="showMoreInfo(${rate.id})"
                                title="${rate.moreInfo ? 'Show more info' : 'No additional info available'}">
                            ${rate.moreInfo ? 'MEHR INFO' : 'No Info'}
                        </button>
                        <a class="angebot-btn"
                           href="${rate.webLink || '#'}"
                           target="_blank"
                           title="Open Link">
                            ZUM ANGEBOT
                        </a>
                    </div>
                `;
            }

            return `
                <tr data-rate-id="${rate.id}">
                    ${fieldCells}
                    <td data-label="Actions">
                        ${actionButtons}
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Modified functions to check authentication before executing admin actions
    function updateFieldValueAjax(rateId, fieldId, value) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to make changes.', true);
            return;
        }

        // Original function code...
        const formData = new FormData();
        formData.append('rateId', rateId);
        formData.append('fieldId', fieldId);
        formData.append('value', value);

        fetch('/field-values/update', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to update field value');
            }
            if (!serverRateFieldValuesMap[rateId]) {
                serverRateFieldValuesMap[rateId] = {};
            }
            serverRateFieldValuesMap[rateId][fieldId] = value;
        })
        .catch(error => {
            console.error('Error updating field value:', error);
            showDeleteNotification('Error updating field value: ' + error.message, true);
        });
    }

    function showDeleteConfirmation(rateId) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to delete items.', true);
            return;
        }

        pendingDeleteId = rateId;
        document.getElementById('deleteConfirmationModal').style.display = 'flex';
        document.getElementById('confirmDeleteBtn').onclick = function () {
            deleteInterestRate(rateId);
        };
    }

    function handleFieldDeleteClick(button) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to delete fields.', true);
            return;
        }

        const fieldId = button.dataset.id;
        const fieldLabel = button.dataset.label;
        showFieldDeleteConfirmation(fieldId, fieldLabel);
    }

    function saveColumnOrder() {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to save changes.', true);
            return;
        }

        // Original saveColumnOrder function code...
        const headers = document.querySelectorAll(".draggable-column");
        const newOrder = Array.from(headers).map(header => header.dataset.fieldId);

        const saveBtn = document.getElementById("saveOrderBtn");
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "Saving...";
        saveBtn.disabled = true;

        fetch('/fields/reorder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': getCsrfToken()
            },
            body: JSON.stringify(newOrder)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to save order");
            }
            return response.text();
        })
        .then(data => {
            orderChanged = false;
            saveBtn.classList.remove("show");
            document.getElementById("orderChangedIndicator").classList.remove("show");
            updateGlobalFieldsCache();
            showDeleteNotification('Column order saved successfully!', false);
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        })
        .catch(error => {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            showDeleteNotification("Error saving order: " + error.message, true);
        });
    }

    // All your other existing JavaScript functions remain the same,
    // but add authentication checks where needed...

    function loadPageFromServer(page, searchTerm = '') {
        if (isLoading) return;

        showLoading();

        const params = new URLSearchParams({
            page: page - 1,
            size: pageSize,
            sortBy: currentSortColumn || 'id',
            sortDir: currentSortDirection || 'asc'
        });

        if (searchTerm && searchTerm.trim()) {
            params.append('search', searchTerm.trim());
        }

    // Use the correct endpoint
    fetch(`/api/interest-rates/paginated?${params.toString()}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }
            return response.json();
        })
        .then(data => {
            currentPage = page;
            totalPages = data.totalPages;
            totalRecords = data.totalElements;

            // Update global data arrays
            allInterestRates = data.content;
            filteredRates = data.content;

            // Store the field values map from server
            serverRateFieldValuesMap = data.rateFieldValuesMap;

            renderTableData(data.content);
            updatePaginationControls();
            updatePaginationInfo();
            hideLoading();

            // Close any expanded cards when changing pages
            if (currentExpandedCard) {
                closeExpandedCard(currentExpandedCard);
            }
        })
        .catch(error => {
            console.error('Error loading page:', error);
            showDeleteNotification('Error loading data: ' + error.message, true);
            hideLoading();
        });
}

    function initializePagination() {
        totalRecords = allInterestRates.length;
        filteredRates = [...allInterestRates];
        updatePaginationInfo();
    }

    function loadPage(page) {
        if (isLoading) return;

        showLoading();
        currentPage = page;

        setTimeout(() => {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = filteredRates.slice(startIndex, endIndex);

            renderTableData(pageData);
            updatePaginationControls();
            updatePaginationInfo();
            hideLoading();

            if (currentExpandedCard) {
                closeExpandedCard(currentExpandedCard);
            }
        }, 300);
    }

    function renderTableData(data) {
        const tbody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');

        if (data.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        const headers = document.querySelectorAll('.draggable-column, .sortable');
        if (headers.length > 0) {
            renderTableRows(data, tbody);
        } else {
            if (!globalFieldsCache) {
                fetchGlobalFields().then(() => {
                    renderTableRows(data, tbody);
                });
            } else {
                renderTableRows(data, tbody);
            }
        }
    }

    let globalFieldsCache = null;
    let serverRateFieldValuesMap = {};

    function fetchGlobalFields() {
        if (globalFieldsCache) {
            return Promise.resolve(globalFieldsCache);
        }

        return fetch('/api/global-fields')
            .then(response => response.json())
            .then(fields => {
                globalFieldsCache = fields;
                return fields;
            })
            .catch(error => {
                console.error('Error fetching global fields:', error);
                return [];
            });
    }

    function updatePaginationControls() {
        totalPages = Math.ceil(filteredRates.length / pageSize);

        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');

        if (firstPageBtn) firstPageBtn.disabled = currentPage === 1;
        if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
        if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages;
        if (lastPageBtn) lastPageBtn.disabled = currentPage === totalPages;

        updatePageNumbers();

        const pageJumpInput = document.getElementById('pageJumpInput');
        if (pageJumpInput) {
            pageJumpInput.max = totalPages;
            pageJumpInput.placeholder = currentPage;
        }
    }

    function updatePageNumbers() {
        const pageNumbers = document.getElementById('pageNumbers');
        const pageNumbersBottom = document.getElementById('pageNumbersBottom');

        if (!pageNumbers) return;

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        let html = '';

        for (let i = startPage; i <= endPage; i++) {
            html += `
                <button class="page-btn ${i === currentPage ? 'active' : ''}"
                        onclick="goToPage(${i})">${i}</button>
            `;
        }

        pageNumbers.innerHTML = html;
        if (pageNumbersBottom) {
            pageNumbersBottom.innerHTML = html;
        }
    }

    function updatePaginationInfo() {
        const startRecord = filteredRates.length === 0 ? 0 : (currentPage - 1) * pageSize + 1;
        const endRecord = Math.min(currentPage * pageSize, filteredRates.length);
        const totalRecords = filteredRates.length;

        const infoText = `Showing ${startRecord}-${endRecord} of ${totalRecords} results`;

        const resultsInfo = document.getElementById('resultsInfo');
        const resultsInfoBottom = document.getElementById('resultsInfoBottom');

        if (resultsInfo) resultsInfo.textContent = infoText;
        if (resultsInfoBottom) resultsInfoBottom.textContent = infoText;
    }

    function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage || isLoading) return;
        loadPage(page);
    }

    function jumpToPage() {
        const input = document.getElementById('pageJumpInput');
        const page = parseInt(input.value);

        if (page && page >= 1 && page <= totalPages) {
            goToPage(page);
            input.value = '';
        }
    }

    function changePageSize(newSize) {
        pageSize = parseInt(newSize);
        currentPage = 1;
        loadPage(1);
    }

    function showLoading() {
        isLoading = true;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.add('show');
    }

    function hideLoading() {
        isLoading = false;
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.remove('show');
    }

    function deleteInterestRate(rateId) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to delete items.', true);
            return;
        }

        fetch(`/interest-rate/${rateId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete interest rate');
            }
            return response.text();
        })
        .then(data => {
            hideDeleteConfirmation();
            showDeleteNotification('Interest rate deleted successfully!', false);
            closeExpandedCard(rateId);

            setTimeout(() => {
                const searchTerm = document.getElementById('searchInput')?.value || '';
                loadPageFromServer(currentPage, searchTerm);
            }, 500);
        })
        .catch(error => {
            hideDeleteConfirmation();
            showDeleteNotification('Error deleting interest rate: ' + error.message, true);
        });
    }

    function sortTable(headerElement, event) {
        if (event && event.type === 'click' && headerElement.classList.contains('dragging')) {
            return;
        }

        const fieldId = headerElement.dataset.fieldId;
        const currentSortField = `field_${fieldId}`;

        let sortDirection = 'asc';
        if (currentSortColumn === currentSortField) {
            sortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        }

        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });

        headerElement.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

        currentSortColumn = currentSortField;
        currentSortDirection = sortDirection;

        currentPage = 1;
        const searchTerm = document.getElementById('searchInput')?.value || '';
        loadPageFromServer(1, searchTerm);

        updateSortInfo(headerElement.querySelector('.header-text').textContent.trim(), sortDirection);
    }

    function updateSortInfo(columnName, direction) {
        const sortInfo = document.getElementById('sortInfo');
        if (sortInfo) {
            if (columnName && direction) {
                let resetButton = '';
                if (isAuthenticated) {
                    resetButton = `<button onclick="resetSort()" style="margin-left: 10px; padding: 2px 6px; font-size: 12px; border: 1px solid #ccc; background: white; border-radius: 3px; cursor: pointer;">Reset</button>`;
                }
                sortInfo.innerHTML = `Sorted by: <strong>${columnName}</strong> ${direction === 'asc' ? '↑' : '↓'} ${resetButton}`;
                sortInfo.style.background = 'linear-gradient(135deg, #e7f3ff, #cce7ff)';
            } else {
                sortInfo.textContent = 'Click column headers to sort ↕️';
                sortInfo.style.background = 'white';
            }
        }
    }

    function resetSort() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });

        currentSortColumn = null;
        currentSortDirection = null;

        currentPage = 1;
        const searchTerm = document.getElementById('searchInput')?.value || '';
        loadPageFromServer(1, searchTerm);

        updateSortInfo();
        showDeleteNotification('Sort reset! Data restored to original order.', false);
    }

    function initializeSearch() {
        const existingSearch = document.querySelector('.search-container');
        if (existingSearch) {
            existingSearch.remove();
        }
    }

    function performSearch() {
        const searchTerm = document.getElementById('searchInput').value;
        currentPage = 1;
        loadPageFromServer(1, searchTerm);
    }

    function clearSearch() {
        document.getElementById('searchInput').value = '';
        currentPage = 1;
        loadPageFromServer(1, '');
    }

    function showMoreInfo(rateId) {
        let rate = allInterestRates.find(r => r.id === rateId);

        if (!rate) {
            fetchRateDetails(rateId).then(rateData => {
                if (rateData && rateData.moreInfo) {
                    displayRateCard(rateData);
                }
            });
            return;
        }

        if (!rate.moreInfo) {
            showDeleteNotification('No additional information available for this rate.', false);
            return;
        }

        displayRateCard(rate);
    }

    function fetchRateDetails(rateId) {
        return fetch(`/api/interest-rate/${rateId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch rate details');
                }
                return response.json();
            })
            .catch(error => {
                console.error('Error fetching rate details:', error);
                showDeleteNotification('Error loading rate details: ' + error.message, true);
                return null;
            });
    }

    function displayRateCard(rate) {
        if (currentExpandedCard && currentExpandedCard !== rate.id) {
            closeExpandedCard(currentExpandedCard);
        }

        let existingCard = document.getElementById(`rateCardRow_${rate.id}`);
        if (existingCard) {
            existingCard.style.display = 'none';
            setTimeout(() => {
                if (existingCard.parentNode) {
                    existingCard.parentNode.removeChild(existingCard);
                }
            }, 0);

            if (currentExpandedCard === rate.id) {
                currentExpandedCard = null;
                return;
            }
        }

        const targetRow = document.querySelector(`tr[data-rate-id="${rate.id}"]`);
        if (!targetRow) return;

        const card = createRateCard(rate);

        const cardRow = document.createElement('tr');
        cardRow.id = `rateCardRow_${rate.id}`;
        cardRow.className = 'rate-card-row show';
        cardRow.innerHTML = `<td colspan="100%" class="rate-card-cell"></td>`;

        cardRow.querySelector('.rate-card-cell').appendChild(card);
        targetRow.parentNode.insertBefore(cardRow, targetRow.nextSibling);

        setTimeout(() => {
            card.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 50);

        currentExpandedCard = rate.id;
    }

    function createRateCard(rate) {
        const card = document.createElement('div');
        card.className = 'rate-card';
        card.id = `rateCard_${rate.id}`;

        const moreInfo = rate.moreInfo;
        if (!moreInfo) return card;

        const sectionOrder = moreInfo.sectionOrder || [];
        const tableSectionsMap = new Map();
        const textSectionsMap = new Map();

        if (moreInfo.tableSections) {
            moreInfo.tableSections.forEach(tableSection => {
                tableSectionsMap.set(tableSection.sectionIdentifier, tableSection);
            });
        }

        if (moreInfo.textSections) {
            moreInfo.textSections.forEach(textSection => {
                textSectionsMap.set(textSection.sectionIdentifier, textSection);
            });
        }

        const createTableSection = (tableSection) => {
            if (!tableSection || !tableSection.title || !tableSection.miniTableRows || tableSection.miniTableRows.length === 0) {
                return '';
            }

            let dragAttributes = '';
            let dragHandle = '';
            let sectionControls = '';

            if (isAuthenticated) {
                dragAttributes = `
                    draggable="true"
                    ondragstart="handleSectionDragStart(event, '${tableSection.sectionIdentifier}', ${rate.id})"
                    ondragover="handleSectionDragOver(event)"
                    ondrop="handleSectionDrop(event, '${tableSection.sectionIdentifier}', ${rate.id})"
                    ondragend="handleSectionDragEnd(event)"
                `;
                dragHandle = `<div class="section-drag-handle" title="Drag to reorder">⋮⋮</div>`;
                sectionControls = `
                    <div class="section-controls">
                        <span class="section-type-indicator">Table</span>
                    </div>
                `;
            }

            return `
                <div class="expanded-section ${isAuthenticated ? 'draggable-section' : ''} table-section"
                     data-section-type="table"
                     data-section-id="${tableSection.sectionIdentifier}"
                     ${dragAttributes}>
                    ${dragHandle}
                    ${sectionControls}
                    <h5 class="section-title">${tableSection.title}</h5>
                    <div class="info-table">
                        ${tableSection.miniTableRows.map(row => `
                            <div class="info-table-row">
                                <div class="info-table-label">${row.label || ''}</div>
                                <div class="info-table-value">${row.description || ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const createTextSection = (textSection) => {
            if (!textSection || (!textSection.title && !textSection.content)) {
                return '';
            }

            let dragAttributes = '';
            let dragHandle = '';
            let sectionControls = '';

            if (isAuthenticated) {
                dragAttributes = `
                    draggable="true"
                    ondragstart="handleSectionDragStart(event, '${textSection.sectionIdentifier}', ${rate.id})"
                    ondragover="handleSectionDragOver(event)"
                    ondrop="handleSectionDrop(event, '${textSection.sectionIdentifier}', ${rate.id})"
                    ondragend="handleSectionDragEnd(event)"
                `;
                dragHandle = `<div class="section-drag-handle" title="Drag to reorder">⋮⋮</div>`;
                sectionControls = `
                    <div class="section-controls">
                        <span class="section-type-indicator">Text</span>
                    </div>
                `;
            }

            return `
                <div class="expanded-section ${isAuthenticated ? 'draggable-section' : ''} text-section"
                     data-section-type="text"
                     data-section-id="${textSection.sectionIdentifier}"
                     ${dragAttributes}>
                    ${dragHandle}
                    ${sectionControls}
                    ${textSection.title ? `<h5 class="section-title">${textSection.title}</h5>` : ''}
                    <div class="text-content" style="text-align: left;">${textSection.content || ''}</div>
                </div>
            `;
        };

        let sectionsHTML = '';
        sectionOrder.forEach(sectionIdentifier => {
            if (sectionIdentifier.startsWith('table-')) {
                const tableSection = tableSectionsMap.get(sectionIdentifier);
                if (tableSection) {
                    sectionsHTML += createTableSection(tableSection);
                }
            } else if (sectionIdentifier.startsWith('text-')) {
                const textSection = textSectionsMap.get(sectionIdentifier);
                if (textSection) {
                    sectionsHTML += createTextSection(textSection);
                }
            }
        });

        tableSectionsMap.forEach((tableSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTableSection(tableSection);
            }
        });

        textSectionsMap.forEach((textSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTextSection(textSection);
            }
        });

        card.innerHTML = `
            <div class="rate-expanded-content show">
                ${sectionsHTML}
            </div>
        `;

        return card;
    }

    function closeExpandedCard(rateId) {
        const cardRow = document.getElementById(`rateCardRow_${rateId}`);
        if (cardRow) {
            cardRow.style.display = 'none';
            cardRow.classList.remove('show');

            requestAnimationFrame(() => {
                if (cardRow.parentNode) {
                    cardRow.parentNode.removeChild(cardRow);
                }
            });

            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
            }
        }
    }

    // Admin-only functions (only available to authenticated users)
    function captureOriginalOrder() {
        if (!isAuthenticated) return;

        const headers = document.querySelectorAll('.draggable-column');
        originalOrder = Array.from(headers).map(header => header.dataset.fieldId);
    }

    function initializeSortableHeaders() {
        const headers = document.querySelectorAll('.draggable-column, .sortable');
        headers.forEach(header => {
            header.classList.add('sortable');
        });
    }

    function showEditForm(fieldId) {
        if (!isAuthenticated) {
            showDeleteNotification('You must be logged in to edit fields.', true);
            return;
        }

        if (currentEditForm) {
            currentEditForm.classList.remove('show');
        }
        const form = document.getElementById('editForm_' + fieldId);
        if (form) {
            form.classList.add('show');
            currentEditForm = form;
        }
    }

    function hideEditForm(fieldId) {
        const form = document.getElementById('editForm_' + fieldId);
        if (form) {
            form.classList.remove('show');
        }
        currentEditForm = null;
    }

    function showFieldDeleteConfirmation(fieldId, fieldLabel) {
        if (!isAuthenticated) return;

        pendingFieldDeleteId = fieldId;
        document.getElementById('fieldToDeleteName').textContent = fieldLabel;
        document.getElementById('fieldToDeleteId').textContent = fieldId;
        document.getElementById('fieldDeleteConfirmationModal').style.display = 'flex';

        document.getElementById('confirmFieldDeleteBtn').onclick = function () {
            deleteGlobalField(fieldId);
        };
    }

    function hideFieldDeleteConfirmation() {
        if (!isAuthenticated) return;

        document.getElementById('fieldDeleteConfirmationModal').style.display = 'none';
        pendingFieldDeleteId = null;
    }

    function deleteGlobalField(fieldId) {
        if (!isAuthenticated) return;

        const confirmBtn = document.getElementById('confirmFieldDeleteBtn');
        const originalText = confirmBtn.textContent;
        confirmBtn.textContent = 'Deleting...';
        confirmBtn.disabled = true;

        fetch(`/fields/delete/${fieldId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete field');
            }
            return response.text();
        })
        .then(data => {
            hideFieldDeleteConfirmation();
            showDeleteNotification('Field deleted successfully! Page will reload...', false);
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        })
        .catch(error => {
            confirmBtn.textContent = originalText;
            confirmBtn.disabled = false;
            showDeleteNotification('Error deleting field: ' + error.message, true);
        });
    }

    function hideDeleteConfirmation() {
        if (!isAuthenticated) return;

        document.getElementById('deleteConfirmationModal').style.display = 'none';
        pendingDeleteId = null;
    }

    function showDeleteNotification(message, isError) {
        const notification = document.getElementById('deleteNotification');
        if (notification) {
            notification.textContent = message;
            notification.classList.toggle('error', isError);
            notification.classList.toggle('success', !isError);
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    }

    // Drag and drop functions (admin only)
    function handleDragStart(event) {
        if (!isAuthenticated) return;

        draggedElement = event.target;
        event.target.classList.add('dragging');
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/html', event.target.outerHTML);
    }

    function handleDragOver(event) {
        if (!isAuthenticated) return;

        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        const target = event.target.closest('.draggable-column');
        if (target && target !== draggedElement) {
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');
            showDropIndicator(target, event);
        }
    }

    function handleDrop(event) {
        if (!isAuthenticated) return;

        event.preventDefault();

        const target = event.target.closest('.draggable-column');
        if (target && target !== draggedElement) {
            const draggedFieldId = draggedElement.dataset.fieldId;
            const targetFieldId = target.dataset.fieldId;

            moveColumn(draggedFieldId, targetFieldId);
            markOrderChanged();
        }

        cleanup();
    }

    function handleDragEnd(event) {
        cleanup();
    }

    function cleanup() {
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
        }
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        hideDropIndicator();
        draggedElement = null;
    }

    function moveColumn(draggedFieldId, targetFieldId) {
        if (!isAuthenticated) return;

        const headerRow = document.getElementById("column-header-row");
        const headers = Array.from(headerRow.querySelectorAll(".draggable-column"));

        const draggedIndex = headers.findIndex(h => h.dataset.fieldId === draggedFieldId);
        const targetIndex = headers.findIndex(h => h.dataset.fieldId === targetFieldId);

        if (draggedIndex === -1 || targetIndex === -1 || draggedIndex === targetIndex) return;

        const draggedHeader = headers[draggedIndex];
        if (targetIndex < draggedIndex) {
            headerRow.insertBefore(draggedHeader, headers[targetIndex]);
        } else {
            headerRow.insertBefore(draggedHeader, headers[targetIndex].nextSibling);
        }

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageData = filteredRates.slice(startIndex, endIndex);

        const tbody = document.getElementById('tableBody');
        renderTableRows(pageData, tbody);
    }

    function markOrderChanged() {
        if (!isAuthenticated) return;

        orderChanged = true;
        document.getElementById("saveOrderBtn").classList.add("show");
        document.getElementById("orderChangedIndicator").classList.add("show");
    }

    function updateGlobalFieldsCache() {
        if (!isAuthenticated) return;

        const headers = document.querySelectorAll('.draggable-column');
        const currentOrder = Array.from(headers).map(header => ({
            id: header.dataset.fieldId,
            label: header.querySelector('.header-text').textContent
        }));

        if (globalFieldsCache) {
            globalFieldsCache = currentOrder.map(orderItem =>
                globalFieldsCache.find(field => field.id == orderItem.id)
            ).filter(Boolean);
        }
    }

    function getCsrfToken() {
        const tokenMeta = document.querySelector('meta[name="_csrf"]');
        return tokenMeta ? tokenMeta.getAttribute('content') : '';
    }

    function showDropIndicator(target, event) {
        if (!isAuthenticated) return;

        const indicator = document.getElementById("dropIndicator");
        if (indicator) {
            const rect = target.getBoundingClientRect();
            indicator.style.left = `${rect.left}px`;
            indicator.style.top = `${rect.top}px`;
            indicator.style.height = `${rect.height}px`;
            indicator.classList.add("show");
        }
    }

    function hideDropIndicator() {
        const indicator = document.getElementById("dropIndicator");
        if (indicator) {
            indicator.classList.remove("show");
        }
    }

    // Section drag and drop functions (admin only)
    function handleSectionDragStart(event, sectionIdentifier, rateId) {
        if (!isAuthenticated) return;

        draggedSection = {
            element: event.target.closest('.expanded-section'),
            identifier: sectionIdentifier,
            rateId: rateId
        };
        draggedSection.element.classList.add('dragging');
        currentRateId = rateId;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', sectionIdentifier);
    }

    function handleSectionDragOver(event) {
        if (!isAuthenticated) return;

        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';

        const target = event.target.closest('.expanded-section');
        if (target && draggedSection && target !== draggedSection.element &&
            target.closest(`#rateCard_${currentRateId}`)) {

            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');
        }
    }

    function handleSectionDrop(event, targetIdentifier, rateId) {
        if (!isAuthenticated) return;

        event.preventDefault();

        if (draggedSection && draggedSection.rateId === rateId && draggedSection.identifier !== targetIdentifier) {
            const sourceElement = draggedSection.element;
            const targetElement = event.target.closest('.expanded-section');

            if (sourceElement && targetElement) {
                const parent = sourceElement.parentElement;
                const sourceIndex = Array.from(parent.children).indexOf(sourceElement);
                const targetIndex = Array.from(parent.children).indexOf(targetElement);

                if (sourceIndex < targetIndex) {
                    parent.insertBefore(sourceElement, targetElement.nextSibling);
                } else {
                    parent.insertBefore(sourceElement, targetElement);
                }

                const sections = parent.querySelectorAll('[data-section-id]');
                const newOrder = Array.from(sections).map(el => el.getAttribute('data-section-id'));

                saveSectionOrder(rateId, newOrder);
            }
        }

        cleanupSectionDrag();
    }

    function handleSectionDragEnd(event) {
        cleanupSectionDrag();
    }

    function cleanupSectionDrag() {
        if (draggedSection && draggedSection.element) {
            draggedSection.element.classList.remove('dragging');
        }
        document.querySelectorAll('.drag-over')
            .forEach(el => el.classList.remove('drag-over'));
        draggedSection = null;
        currentRateId = null;
    }

    // Save section order - single implementation
    function saveSectionOrder(rateId, newOrder) {
        fetch(`/sections/reorder?rateId=${rateId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newOrder)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to save section order");
                }
                return response.text();
            })
            .catch(error => {
                showDeleteNotification("Error saving section order: " + error.message, true);
            });
    }

    function showMoreInfo(rateId) {
        const rate = filteredRates.find(r => r.id === rateId) || allInterestRates.find(r => r.id === rateId);
        if (!rate || !rate.moreInfo) return;

        // Close any currently expanded card
        if (currentExpandedCard && currentExpandedCard !== rateId) {
            closeExpandedCard(currentExpandedCard);
        }

        let existingCard = document.getElementById(`rateCardRow_${rateId}`);
        if (existingCard) {
            // FIXED: Properly remove the card and clean up
            existingCard.style.display = 'none';
            setTimeout(() => {
                if (existingCard.parentNode) {
                    existingCard.parentNode.removeChild(existingCard);
                }
            }, 0);

            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
                return;
            }
        }

        // Find the table row that was clicked
        const tableRows = document.querySelectorAll('tbody tr');
        let targetRow = null;

        tableRows.forEach(row => {
            const button = row.querySelector('.mehr-info-btn');
            if (button && button.onclick && button.onclick.toString()
                .includes(`showMoreInfo(${rateId})`)) {
                targetRow = row;
            }
        });

        if (!targetRow) return;

        const card = createRateCard(rate);

        const cardRow = document.createElement('tr');
        cardRow.id = `rateCardRow_${rateId}`;
        cardRow.className = 'rate-card-row show';
        cardRow.innerHTML = `<td colspan="100%" class="rate-card-cell"></td>`;

        cardRow.querySelector('.rate-card-cell')
            .appendChild(card);

        targetRow.parentNode.insertBefore(cardRow, targetRow.nextSibling);

        setTimeout(() => {
            card.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 50);

        currentExpandedCard = rateId;
    }

    function createRateCard(rate) {
        const card = document.createElement('div');
        card.className = 'rate-card';
        card.id = `rateCard_${rate.id}`;

        const moreInfo = rate.moreInfo;
        if (!moreInfo) return card;

        // Get the section order from the data, default to empty array
        const sectionOrder = moreInfo.sectionOrder || [];

        // Create section content maps
        const tableSectionsMap = new Map();
        const textSectionsMap = new Map();

        // Map table sections by identifier
        if (moreInfo.tableSections) {
            moreInfo.tableSections.forEach(tableSection => {
                tableSectionsMap.set(tableSection.sectionIdentifier, tableSection);
            });
        }

        // Map text sections by identifier
        if (moreInfo.textSections) {
            moreInfo.textSections.forEach(textSection => {
                textSectionsMap.set(textSection.sectionIdentifier, textSection);
            });
        }

        // Helper function to create table sections
        const createTableSection = (tableSection) => {
            if (!tableSection || !tableSection.title || !tableSection.miniTableRows || tableSection.miniTableRows.length === 0) {
                return '';
            }
            return `
                    <div class="expanded-section draggable-section table-section"
                         draggable="true"
                         data-section-type="table"
                         data-section-id="${tableSection.sectionIdentifier}"
                         ondragstart="handleSectionDragStart(event, '${tableSection.sectionIdentifier}', ${rate.id})"
                         ondragover="handleSectionDragOver(event)"
                         ondrop="handleSectionDrop(event, '${tableSection.sectionIdentifier}', ${rate.id})"
                         ondragend="handleSectionDragEnd(event)">
                        <div class="section-drag-handle" title="Drag to reorder">⋮⋮</div>
                        <div class="section-controls">
                            <span class="section-type-indicator">Table</span>
                        </div>
                        <h5 class="section-title">${tableSection.title}</h5>
                        <div class="info-table">
                            ${tableSection.miniTableRows.map(row => `
                                <div class="info-table-row">
                                    <div class="info-table-label">${row.label || ''}</div>
                                    <div class="info-table-value">${row.description || ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
        };

        // Helper function to create text sections
        const createTextSection = (textSection) => {
            if (!textSection || (!textSection.title && !textSection.content)) {
                return '';
            }
            return `
                    <div class="expanded-section draggable-section text-section"
                         draggable="true"
                         data-section-type="text"
                         data-section-id="${textSection.sectionIdentifier}"
                         ondragstart="handleSectionDragStart(event, '${textSection.sectionIdentifier}', ${rate.id})"
                         ondragover="handleSectionDragOver(event)"
                         ondrop="handleSectionDrop(event, '${textSection.sectionIdentifier}', ${rate.id})"
                         ondragend="handleSectionDragEnd(event)">
                        <div class="section-drag-handle" title="Drag to reorder">⋮⋮</div>
                        <div class="section-controls">
                            <span class="section-type-indicator">Text</span>
                        </div>
                        ${textSection.title ? `<h5 class="section-title">${textSection.title}</h5>` : ''}
                        <div class="text-content" style="text-align: left;">${textSection.content || ''}</div>
                    </div>
                `;
        };

        // Build sections in the correct order
        let sectionsHTML = '';
        sectionOrder.forEach(sectionIdentifier => {
            if (sectionIdentifier.startsWith('table-')) {
                const tableSection = tableSectionsMap.get(sectionIdentifier);
                if (tableSection) {
                    sectionsHTML += createTableSection(tableSection);
                }
            } else if (sectionIdentifier.startsWith('text-')) {
                const textSection = textSectionsMap.get(sectionIdentifier);
                if (textSection) {
                    sectionsHTML += createTextSection(textSection);
                }
            }
        });

        // Add any sections not in the order (fallback)
        tableSectionsMap.forEach((tableSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTableSection(tableSection);
            }
        });

        textSectionsMap.forEach((textSection, identifier) => {
            if (!sectionOrder.includes(identifier)) {
                sectionsHTML += createTextSection(textSection);
            }
        });

        card.innerHTML = `
                <div class="rate-expanded-content show">
                    ${sectionsHTML}
                </div>
            `;

        return card;
    }

    function closeExpandedCard(rateId) {
        const cardRow = document.getElementById(`rateCardRow_${rateId}`);
        if (cardRow) {
            // FIXED: Properly hide and remove the card to prevent white space
            cardRow.style.display = 'none';
            cardRow.classList.remove('show');

            // Use requestAnimationFrame to ensure proper cleanup
            requestAnimationFrame(() => {
                if (cardRow.parentNode) {
                    cardRow.parentNode.removeChild(cardRow);
                }
            });

            if (currentExpandedCard === rateId) {
                currentExpandedCard = null;
            }
        }
    }

    function showEditForm(fieldId) {
        if (currentEditForm) {
            currentEditForm.classList.remove('show');
        }
        const form = document.getElementById('editForm_' + fieldId);
        if (form) {
            form.classList.add('show');
            currentEditForm = form;
        }
    }

    function hideEditForm(fieldId) {
        const form = document.getElementById('editForm_' + fieldId);
        if (form) {
            form.classList.remove('show');
        }
        currentEditForm = null;
    }

    document.addEventListener('click', function (e) {
        if (currentEditForm && !currentEditForm.contains(e.target) && !e.target.classList.contains('edit-header-btn')) {
            currentEditForm.classList.remove('show');
            currentEditForm = null;
        }
    });

    // Enhanced keyboard navigation for pagination
    document.addEventListener('keydown', function (e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        switch (e.key) {
        case 'ArrowLeft':
            if (currentPage > 1) {
                e.preventDefault();
                goToPage(currentPage - 1);
            }
            break;
        case 'ArrowRight':
            if (currentPage < totalPages) {
                e.preventDefault();
                goToPage(currentPage + 1);
            }
            break;
        case 'Home':
            e.preventDefault();
            goToPage(1);
            break;
        case 'End':
            e.preventDefault();
            goToPage(totalPages);
            break;
        }
    });

    // Handle Enter key in page jump input
    document.getElementById('pageJumpInput')
        .addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                jumpToPage();
            }
        });

    window.addEventListener('resize', function () {
        const tableContainer = document.getElementById('tableContainer');
        const stackedViewBtn = document.getElementById('stackedView');
        const scrollViewBtn = document.getElementById('scrollView');

        if (window.innerWidth > 768) {
            tableContainer.classList.remove('mobile-stack');
            if (stackedViewBtn) stackedViewBtn.style.display = 'none';
            if (scrollViewBtn) scrollViewBtn.style.display = 'none';
        } else {
            if (stackedViewBtn) stackedViewBtn.style.display = 'inline-block';
            if (scrollViewBtn) scrollViewBtn.style.display = 'inline-block';

            if (!tableContainer.classList.contains('mobile-stack') &&
                stackedViewBtn && stackedViewBtn.classList.contains('active')) {
                tableContainer.classList.add('mobile-stack');
            }
        }
    });
</script>
</body>
</html>